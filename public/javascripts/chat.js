// Generated by CoffeeScript 1.7.1
var htmlEntities, name, pageTitleNotification;

name = '';

htmlEntities = function(string) {
  return String(string).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
};

pageTitleNotification = {
  vars: {
    originalTitle: document.title,
    interval: null
  },
  on: function(notification, intervalSpeed) {
    var that;
    if (intervalSpeed == null) {
      intervalSpeed = 1000;
    }
    that = this;
    that.vars.interval = setInterval(function() {
      return document.title = that.vars.originalTitle === document.title ? notification : that.vars.originalTitle;
    }, intervalSpeed);
    return true;
  },
  off: function() {
    clearInterval(this.vars.interval);
    document.title = this.vars.originalTitle;
    return true;
  }
};

$(function() {
  var $content, $field, $joinButton, $joinGame, $name, $playGame, $sendButton, $startButton, $startGame, $username, $window, joinGame, logs, sendMessage, socket, startGame, windowFocus;
  $window = $(window);
  windowFocus = true;
  socket = io.connect(window.location.origin);
  logs = [];
  $joinGame = $('#join-game');
  $username = $('#username');
  $joinButton = $('#join');
  $startGame = $('#start-game');
  $startButton = $('#start');
  $playGame = $('#play-game');
  $content = $('#content');
  $name = $('#name');
  $field = $('#field');
  $sendButton = $('#send');
  $window.on('focus', function(event) {
    windowFocus = true;
    pageTitleNotification.off();
    return true;
  });
  $window.on('blur', function(event) {
    windowFocus = false;
    return true;
  });
  socket.on('message', function(data) {
    var $message, text, username;
    if (data.message) {
      logs.push(data);
      username = data.username ? data.username : 'Server';
      text = data.message;
      $message = $('<div>', {
        "class": 'message'
      });
      $message.append($('<strong>', {
        html: "" + username + ": "
      }));
      $message.append(text);
      $content.append($message);
      $content.scrollTop($content.prop('scrollHeight'));
      if (data.username && username !== name && !windowFocus) {
        pageTitleNotification.off();
        pageTitleNotification.on("" + username + " says " + text, 1500);
      }
    } else {
      console.log("There is a problem: " + data);
    }
    return true;
  });
  socket.on('game', function(data) {
    var $player, $playerCards, $playerCredits, $playerPanel, $playerTitle, command, index, player, players;
    if (data.command) {
      command = data.command;
      switch (command) {
        case 'update-board':
          players = data.players;
          for (index in players) {
            player = players[index];
            $player = $("#player-" + index);
            console.log($player);
            $playerPanel = $player.find('.panel');
            $playerTitle = $player.find('.panel-title');
            $playerCards = [$player.find('.card-0'), $player.find('.card-1')];
            $playerCredits = $player.find('.credits');
            $playerPanel.removeClass('panel-default').addClass('panel-primary');
            $playerTitle.html(player.name);
            $playerCards[0].prop('src', player.cards[0]);
            $playerCards[1].prop('src', player.cards[1]);
            $playerCredits.html("" + player.credits + " Credits");
          }
          return console.log(players);
      }
    }
  });
  joinGame = function() {
    var player;
    if ($username.val() === '') {
      alert('Please enter your name!');
    } else {
      name = htmlEntities($username.val());
      $name.html(name);
      player = {
        name: name,
        cards: ['/images/card_face_down.png', '/images/card_face_down.png'],
        credits: 2
      };
      socket.emit('send', {
        message: "<em>" + name + " joined the game</em>"
      });
      socket.emit('play', {
        command: 'join-game',
        player: player
      });
      $joinGame.collapse('hide');
      $startGame.collapse('show');
    }
    return true;
  };
  $joinButton.on('click', function(event) {
    joinGame();
    return true;
  });
  $username.on('keydown', function(event) {
    if (event.keyCode === 13) {
      joinGame();
    }
    return true;
  });
  startGame = function() {
    socket.emit('play', {
      command: 'start-game'
    });
    $startGame.collapse('hide');
    $playGame.collapse('show');
    $field.trigger('focus');
    return true;
  };
  $startButton.on('click', function(event) {
    startGame();
    return true;
  });
  sendMessage = function() {
    var text;
    if ($field.val() === '') {
      alert('Please enter a message!');
    } else {
      text = htmlEntities($field.val());
      socket.emit('send', {
        username: name,
        message: text
      });
      $field.val('');
      $field.trigger('focus');
    }
    return true;
  };
  $sendButton.on('click', function(event) {
    sendMessage();
    return true;
  });
  $field.on('keydown', function(event) {
    if (event.keyCode === 13) {
      sendMessage();
    }
    return true;
  });
  $username.trigger('focus');
  socket.emit('play', {
    command: 'reset-game'
  });
});
